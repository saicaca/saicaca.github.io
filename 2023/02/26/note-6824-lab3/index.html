<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>6.824 Lab 3 笔记 | Saica&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="目标 实现 Put(key, value), Append(key, arg), Get(key) Get 当输入了不存在的 key 时应返回空字符串 对不存在的 key 进行的 Append 操作应该等同于 Put   Each client talks to the service  through a Cleck Service 必须具备强一致性，可串行化  说明 我们的每一个 kvserv">
<meta property="og:type" content="article">
<meta property="og:title" content="6.824 Lab 3 笔记">
<meta property="og:url" content="http://example.com/2023/02/26/note-6824-lab3/index.html">
<meta property="og:site_name" content="Saica&#39;s Blog">
<meta property="og:description" content="目标 实现 Put(key, value), Append(key, arg), Get(key) Get 当输入了不存在的 key 时应返回空字符串 对不存在的 key 进行的 Append 操作应该等同于 Put   Each client talks to the service  through a Cleck Service 必须具备强一致性，可串行化  说明 我们的每一个 kvserv">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-02-26T12:52:21.000Z">
<meta property="article:modified_time" content="2023-03-12T13:59:01.488Z">
<meta property="article:author" content="Saica.go">
<meta property="article:tag" content="Back-end">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="Lab">
<meta property="article:tag" content="Distributed Systems">
<meta property="article:tag" content="6.824">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Saica's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/assets/banner.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vix-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Saica's Blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      <image src=/assets/avatar.png></image>
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Saica.go </div>
      <div class="dot"></div>
      <div class="subtitle">(A noob to) web development/UI design </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/saicaca/" title="GitHub"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://steamcommunity.com/id/saicaca/" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Tags</h3>
      <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6-824/" rel="tag">6.824</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Back-end/" rel="tag">Back-end</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Design/" rel="tag">Design</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Distributed-Systems/" rel="tag">Distributed Systems</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/English/" rel="tag">English</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Front-end/" rel="tag">Front-end</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lab/" rel="tag">Lab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Archives</h3>
      
      
        <a class="archive-link" href="/archives/2023/02 ">
          February 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2021/05 ">
          May 2021 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2021/03 ">
          March 2021 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2020/09 ">
          September 2020 
          <div class="archive-count">1 </div>
        </a>
      
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-note-6824-lab3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="title-bar">
  <div class="title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        6.824 Lab 3 笔记
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <a href="/2023/02/26/note-6824-lab3/" class="meta-info">
  <time class="dt-published" datetime="2023-02-26T12:52:21.000Z" itemprop="datePublished">2023-02-26</time>
</a>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            2.9k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6-824/" rel="tag">6.824</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Back-end/" rel="tag">Back-end</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Distributed-Systems/" rel="tag">Distributed Systems</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lab/" rel="tag">Lab</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>实现 <code>Put(key, value)</code>, <code>Append(key, arg)</code>, <code>Get(key)</code><ul>
<li><code>Get</code> 当输入了不存在的 key 时应返回空字符串</li>
<li>对不存在的 key 进行的 <code>Append</code> 操作应该等同于 <code>Put</code></li>
</ul>
</li>
<li>Each client talks to the service  through a <code>Cleck</code></li>
<li>Service 必须具备强一致性，可串行化</li>
</ul>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>我们的每一个 <code>kvserver</code> 都有一个相关联的 Raft 节点， <code>Clerks</code> 会将三种 RPC 请求发送到与 Raft leader 相关联的 <code>kvserver</code></li>
<li><code>Clerk</code> 并不一定知道哪个服务器是 Leader，如果请求发送到了错误的服务器或无法连接服务器， <code>Clerk</code> 应该自动重新尝试发送到其他服务器</li>
<li>如果 operation 对应的 log 被 commit 了，leader 应该 respond RPC，如果 operation failed to commit，则应该返回错误，然后 <code>Clerk</code> 尝试其他服务器</li>
<li>各个 kvserver 不能直接通信，只能通过 Raft 通信</li>
<li><code>client.go</code> 是 <code>Clerk</code> 的客户端，负责向各个 <code>kvserver</code> 发送 RPC 请求，</li>
<li><code>server.go</code> 是 <code>kvserver</code> 的代码</li>
</ul>
<h2 id="需要考虑的问题"><a href="#需要考虑的问题" class="headerlink" title="需要考虑的问题"></a>需要考虑的问题</h2><h3 id="防止-Operation-重复"><a href="#防止-Operation-重复" class="headerlink" title="防止 Operation 重复"></a>防止 Operation 重复</h3><p>Server 可能在执行 Command 后、向 Client 返回结果前崩溃，此时 Client 会向另一个 Server 发送同一条 Operation，这时必须保证这条 Operation 只被执行一次。</p>
<p>我目前的解决方法是为每一条 Operation 生成一个 UUID，再用 Set 保存已经执行过的 Operation 的 UUID。（最开始用的是 <code>rand.Int()</code>生成 ID，但后面发现这样总是会多次生成出同一个 ID，即便用时间戳设置了 seed，没搞清楚原因）</p>
<h3 id="处理-Operation-丢失的情况（结合-Figure-8-理解）"><a href="#处理-Operation-丢失的情况（结合-Figure-8-理解）" class="headerlink" title="处理 Operation 丢失的情况（结合 Figure 8 理解）"></a>处理 Operation 丢失的情况（结合 Figure 8 理解）</h3><p>Raft 并不保证通过 <code>Start()</code> 发送的 operation 一定会被 commit，比如像 <code>Figure 8</code> 里的 log 3 最终被舍弃。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> logIndex &lt;= kv.appliedIndex &#123; <span class="comment">// The log failed to commit</span></span><br><span class="line">		reply.Err = ErrCommandLost</span><br><span class="line">		kv.mu.Unlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="避免过大的内存占用"><a href="#避免过大的内存占用" class="headerlink" title="避免过大的内存占用"></a>避免过大的内存占用</h3><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><ul>
<li><p>为每个客户端生成随机的 <code>clientId</code>，为每个客户端分别记录 <code>opIndex</code> ，这样通过 <code>clientId</code> 和 <code>logIndex</code> 能唯一对应一条命令。</p>
</li>
<li><p>Service 使用下面的结构存储指令执行结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> KVServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	OpMap        <span class="keyword">map</span>[<span class="type">string</span>]*OpResult</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OpResult <span class="keyword">struct</span> &#123;</span><br><span class="line">	ClientOpIdx <span class="type">int</span></span><br><span class="line">	Value       <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>OpMap[clientId]</code> 代表相应客户端<strong>最近一条成功 applied 的命令</strong>状态， <code>ClientOpIdx</code> 是对该客户端来说该命令的 Index，Value 存储 <code>GET</code> 命令所获取到的值。  </p>
<p>Lab 说明里的一句话很重要：”It’s OK to assume that a client will make only one call into a Clerk at a time”。客户端每次只会发出一条命令，当收到 <code>Operation n</code> 时 <code>Operation n-1</code> 就不再需要保留了 。</p>
</li>
<li><p>Service 的 <code>Get</code> 、<code>PutAppend</code> 方法大致执行流程：</p>
<ul>
<li>将 <code>Op</code> 发送至 <code>kv.rf.Start()</code></li>
<li><code>if !isLeader</code> 返回</li>
<li>循环等待直到 <code>OpMap[clientId].ClientOpIdx</code> 变为当前指令的 index，说明当前指令已完成，返回结果<ul>
<li>若一段时间后等不到结果，返回错误，客户端重新请求执行同一条指令</li>
</ul>
</li>
</ul>
</li>
<li><p><code>loopReceive()</code> 从 <code>kv.applyCh</code> 里不断获取 <code>Op</code> 并立即 Apply，同时更新 <code>OpMap[clientId]</code></p>
<ul>
<li>如果 Service 新收到的 <code>Op.id</code> ≤ <code>OpMap[clientId].ClientOpIdx</code> ，则可认为收到了重复的命令，跳过不执行。</li>
<li>不用担心 <code>OpMap</code> 更新太快导致 <code>Get</code> 和 <code>PutAppend</code> 来不及获取结果。因为如上面所说客户端每次只会发出一条指令，在客户端正确收到指令 n 的执行结果前，Service 是不会收到指令 n+1 的。同样地，如果当前 <code>OpMap[clientId].ClientOpIdx</code> 为 <code>n</code>，说明指令 <code>n-1</code> 已经完成，<code>Get</code> 和 <code>PutAppend</code> 应该随便返回什么都行。</li>
</ul>
</li>
</ul>
<h3 id="踩坑-1"><a href="#踩坑-1" class="headerlink" title="踩坑 1"></a>踩坑 1</h3><p>在 <code>ops complete fast enough (3A)</code> 这个测试上遇到了问题，test 要求每条指令平均在 33.3ms 内完成，而我的代码需要 150+ ms</p>
<p>问题出在 Raft 的实现上，按当前的实现，Raft Leader 每次通过 <code>Start()</code> 接收到的 Command 会等到下一次 <code>AppendEntries</code> 才被发送到其它节点。Lab 3A 的提示写到 Client 一次只会发送一条指令，而根据 Lab 2 的要求，AppendEntries 的循环间隔不能小于 100ms，因此仅凭普通的 <code>AppendEntries</code> 循环来复制指令应该是无法满足时间要求的。</p>
<p>最后修改了一下 Raft 的实现：</p>
<ol>
<li>每次通过 <code>Start()</code> 接收到指令时马上发起 <code>AppendEntries</code> ，</li>
<li>缩短检查 log 的 commit 和 apply 情况的间隔时间，原本设置了一个 80ms 的间隔，测试发现这个间隔设置得越短 test 完成的速度就越快。最后设置到了 1ms，test 的完成时间接近官网上的 15s。但如果完全不设置间隔又会导致超时。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">... Passed --  <span class="number">14.0</span>  <span class="number">3</span>  <span class="number">3030</span>    <span class="number">0</span></span><br><span class="line">PASS</span><br><span class="line">ok      <span class="number">6.824</span>/kvraft    <span class="number">13.994</span>s</span><br></pre></td></tr></table></figure>

<ul>
<li>（或许应该改用 channel 实现这一步骤）</li>
</ul>
<h3 id="踩坑-2"><a href="#踩坑-2" class="headerlink" title="踩坑 2"></a>踩坑 2</h3><p>最开始我没有使用超时机制解决指令丢失问题，而是记录当前执行完成的 Raft 的 <code>logIndex</code> ，如果过号了 <code>Get</code> <code>PutAppend</code> 方法还没有查询到结果就说明指令丢失了。</p>
<p>这个实现在 <code>TestOnePartition3A</code> 中遇到了问题：中途会有请求永远得不到响应的问题。</p>
<p>最后检查发现是我的 Raft 实现里遗留的一个问题。</p>
<p>如 Raft 协议规定，Leader 不能直接 commit 来自先前 term 的 entry ，只能在 commit 当前 term 的 entry 的时候间接地 commit。因此如果遇到了 <code>Figure 8</code> 中的那种情况（最新的 entry 来自先前的 term），而又一直没有从 client 接收到新的 entry，那么先前的 entry 就永远无法 commit。而这个 Test 中的指令又是每次一条地发送，程序就卡在这了。</p>
<p><strong>解决方法 1</strong></p>
<p>感觉最正确的做法应该是在 Raft 代码里补上 no-op entry 的实现，让 Raft 节点在当选 Leader 的时候立即 append 一个 <code>no-op</code> entry。</p>
<p>这样写能通过 Lab 3A 的测试，但之后我发现这样会让 Lab 2 的测试挂掉，似乎是会被测试程序判定为 log 数量不正确或是 log 乱序，不管是跳过 no-op entry 的 apply 或是把 <code>CommandValid</code> 设置为 <code>false</code> 都不行，目前没找到解决办法。</p>
<p><strong>解决方法 2</strong></p>
<p>把 no-op entry 放在 Service 层实现，Service 持续检查 Raft 状态，检测到 term 变化时发送一个空的 Operation，感觉这样写比较麻烦。</p>
<p><strong><strong>解决方法 3</strong></strong></p>
<p>最后采用了最简单的方法。不实现 no-op entry，在 Service 中的 Get &#x2F; PutAppend 方法里加上超时检测，超过时限后直接返回错误让客户端重发一遍，也能解决这个问题。</p>
<h3 id="Recover"><a href="#Recover" class="headerlink" title="Recover"></a>Recover</h3><p>虽然好像课程网站上 3A 的部分没有明确提到，但是带有 <code>Persist</code> 字样的 Test 都是要求实现恢复机制的，大概就是在 <code>StartKVServer()</code> 里从 Raft 中获取已经 Applied 的 Operations，从头开始执行一遍即可。</p>
<h1 id="3B"><a href="#3B" class="headerlink" title="3B"></a>3B</h1><h2 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h2><p>实现 Snapshot 和恢复功能</p>
<ul>
<li>时刻检测 <code>Raft State</code> 大小（包括 log，但不包括 Snapshot），使用 <code>maxraftstate</code> 和 <code>persister.RaftStateSize()</code> 进行对比，到达阈值时调用 <code>Snapshot</code> 函数，which in turn use <code>persister.SaveRaftState()</code> （没看懂什么意思）。<ul>
<li>如果 <code>maxraftstate == -1</code> ，则不进行保存快照操作。</li>
</ul>
</li>
<li>从 applych 收到 Snapshot 的时候，调用 <code>CondInstallSnapshot</code> ，参见 2D 笔记</li>
<li>Service 重启时读取 Snapshot</li>
<li>checkpoint 前后的 operations 有可能重复，用于检查重复 operations 的数据也需要保存到 snapshot 里</li>
</ul>
<h2 id="方案-1"><a href="#方案-1" class="headerlink" title="方案"></a>方案</h2><ol>
<li>定时检查 Raft 状态大小，当超出阈值时调用 <code>kv.rf.Snapshot()</code> 保存快照</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kv *KVServer)</span></span> checkSize(persister *raft.Persister) &#123;</span><br><span class="line">	<span class="keyword">if</span> kv.maxraftstate == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> persister.RaftStateSize() &gt; <span class="type">int</span>(<span class="type">float64</span>(kv.maxraftstate)*LOG_TRIM_THRESHOLD) &#123;</span><br><span class="line">			kv.mu.Lock()</span><br><span class="line">			snapshot := KVSnapshot&#123;</span><br><span class="line">				Data:         kv.data,</span><br><span class="line">				AppliedIndex: kv.appliedIndex,</span><br><span class="line">				OpMap:        kv.OpMap,</span><br><span class="line">			&#125;</span><br><span class="line">			binary := Encode(snapshot)</span><br><span class="line">			idx := kv.appliedIndex</span><br><span class="line">			<span class="keyword">go</span> kv.rf.Snapshot(idx, binary)</span><br><span class="line">			kv.mu.Unlock()</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(LOG_SIZE_CHECK_INTERVAL * time.Millisecond)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>从 <code>applyCh</code> 收到 Snapshot 时调用 <code>kv.rf.CondInstallSnapshot()</code></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> data.SnapshotValid &#123;</span><br><span class="line">	<span class="comment">// 调用 CondInstallSnapshot</span></span><br><span class="line">	<span class="keyword">if</span> ok := kv.rf.CondInstallSnapshot(data.SnapshotTerm, data.SnapshotIndex, data.Snapshot); ok &#123;</span><br><span class="line">		<span class="keyword">if</span> ok, snapshot := Decode(data.Snapshot); ok &#123;</span><br><span class="line">			kv.mu.Lock()</span><br><span class="line">			kv.applySnapshot(snapshot)</span><br><span class="line">			kv.mu.Unlock()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kv *KVServer)</span></span> applySnapshot(snapshot *KVSnapshot) &#123;</span><br><span class="line">	kv.DPrintf(<span class="string">&quot;Applying snapshot\n&quot;</span>)</span><br><span class="line">	kv.data = snapshot.Data</span><br><span class="line">	kv.appliedIndex = snapshot.AppliedIndex</span><br><span class="line">	kv.OpMap = snapshot.OpMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>启动时尝试读取并恢复 Snapshot</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">snapshotByte := persister.ReadSnapshot()</span><br><span class="line"><span class="keyword">if</span> ok, snapshot := Decode(snapshotByte); ok &#123;</span><br><span class="line">	kv.applySnapshot(snapshot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="踩坑-1-操作丢失问题"><a href="#踩坑-1-操作丢失问题" class="headerlink" title="踩坑 1. 操作丢失问题"></a>踩坑 1. 操作丢失问题</h3><p>在涉及 Recover 的测试里遇到了如下的报错</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test_test.<span class="keyword">go</span>:<span class="number">287</span>: get wrong value, key <span class="number">0</span>, wanted:</span><br><span class="line"></span><br><span class="line">        x <span class="number">0</span> <span class="number">0</span> yx <span class="number">0</span> <span class="number">1</span> yx <span class="number">0</span> <span class="number">2</span> yx <span class="number">0</span> <span class="number">3</span> yx <span class="number">0</span> <span class="number">4</span> yx <span class="number">0</span> <span class="number">5</span> yx <span class="number">0</span> <span class="number">6</span> yx <span class="number">0</span> <span class="number">7</span> yx <span class="number">0</span> <span class="number">8</span> yx <span class="number">0</span> <span class="number">9</span> yx <span class="number">0</span> <span class="number">10</span> yx <span class="number">0</span> <span class="number">11</span> yx <span class="number">0</span> <span class="number">12</span> yx <span class="number">0</span> <span class="number">13</span> yx <span class="number">0</span> <span class="number">14</span> yx <span class="number">0</span> <span class="number">15</span> yx <span class="number">0</span> <span class="number">16</span> yx <span class="number">0</span> <span class="number">17</span> yx <span class="number">0</span> <span class="number">18</span> yx <span class="number">0</span> <span class="number">19</span> yx <span class="number">0</span> <span class="number">20</span> yx <span class="number">0</span> <span class="number">21</span> yx <span class="number">0</span> <span class="number">22</span> yx <span class="number">0</span> <span class="number">23</span> yx <span class="number">0</span> <span class="number">24</span> yx <span class="number">0</span> <span class="number">25</span> yx <span class="number">0</span> <span class="number">26</span> yx <span class="number">0</span> <span class="number">27</span> yx <span class="number">0</span> <span class="number">28</span> yx <span class="number">0</span> <span class="number">29</span> yx <span class="number">0</span> <span class="number">30</span> yx <span class="number">0</span> <span class="number">31</span> yx <span class="number">0</span> <span class="number">32</span> yx <span class="number">0</span> <span class="number">33</span> yx <span class="number">0</span> <span class="number">34</span> yx <span class="number">0</span> <span class="number">35</span> yx <span class="number">0</span> <span class="number">36</span> yx <span class="number">0</span> <span class="number">37</span> yx <span class="number">0</span> <span class="number">38</span> yx <span class="number">0</span> <span class="number">39</span> yx <span class="number">0</span> <span class="number">40</span> yx <span class="number">0</span> <span class="number">41</span> yx <span class="number">0</span> <span class="number">42</span> yx <span class="number">0</span> <span class="number">43</span> yx <span class="number">0</span> <span class="number">44</span> yx <span class="number">0</span> <span class="number">45</span> yx <span class="number">0</span> <span class="number">46</span> yx <span class="number">0</span> <span class="number">47</span> yx <span class="number">0</span> <span class="number">48</span> yx <span class="number">0</span> <span class="number">49</span> yx <span class="number">0</span> <span class="number">50</span> yx <span class="number">0</span> <span class="number">51</span> yx <span class="number">0</span> <span class="number">52</span> yx <span class="number">0</span> <span class="number">53</span> yx <span class="number">0</span> <span class="number">54</span> yx <span class="number">0</span> <span class="number">55</span> yx <span class="number">0</span> <span class="number">56</span> yx <span class="number">0</span> <span class="number">57</span> yx <span class="number">0</span> <span class="number">58</span> yx <span class="number">0</span> <span class="number">59</span> yx <span class="number">0</span> <span class="number">60</span> yx <span class="number">0</span> <span class="number">61</span> yx <span class="number">0</span> <span class="number">62</span> yx <span class="number">0</span> <span class="number">63</span> yx <span class="number">0</span> <span class="number">64</span> yx <span class="number">0</span> <span class="number">65</span> yx <span class="number">0</span> <span class="number">66</span> yx <span class="number">0</span> <span class="number">67</span> yx <span class="number">0</span> <span class="number">68</span> yx <span class="number">0</span> <span class="number">69</span> yx <span class="number">0</span> <span class="number">70</span> yx <span class="number">0</span> <span class="number">71</span> yx <span class="number">0</span> <span class="number">72</span> yx <span class="number">0</span> <span class="number">73</span> yx <span class="number">0</span> <span class="number">74</span> yx <span class="number">0</span> <span class="number">75</span> yx <span class="number">0</span> <span class="number">76</span> yx <span class="number">0</span> <span class="number">77</span> yx <span class="number">0</span> <span class="number">78</span> yx <span class="number">0</span> <span class="number">79</span> yx <span class="number">0</span> <span class="number">80</span> yx <span class="number">0</span> <span class="number">81</span> yx <span class="number">0</span> <span class="number">82</span> yx <span class="number">0</span> <span class="number">83</span> yx <span class="number">0</span> <span class="number">84</span> yx <span class="number">0</span> <span class="number">85</span> yx <span class="number">0</span> <span class="number">86</span> yx <span class="number">0</span> <span class="number">87</span> yx <span class="number">0</span> <span class="number">88</span> yx <span class="number">0</span> <span class="number">89</span> yx <span class="number">0</span> <span class="number">90</span> yx <span class="number">0</span> <span class="number">91</span> yx <span class="number">0</span> <span class="number">92</span> yx <span class="number">0</span> <span class="number">93</span> yx <span class="number">0</span> <span class="number">94</span> yx <span class="number">0</span> <span class="number">95</span> yx <span class="number">0</span> <span class="number">96</span> yx <span class="number">0</span> <span class="number">97</span> yx <span class="number">0</span> <span class="number">98</span> yx <span class="number">0</span> <span class="number">99</span> yx <span class="number">0</span> <span class="number">100</span> yx <span class="number">0</span> <span class="number">101</span> yx <span class="number">0</span> <span class="number">102</span> yx <span class="number">0</span> <span class="number">103</span> yx <span class="number">0</span> <span class="number">104</span> yx <span class="number">0</span> <span class="number">105</span> yx <span class="number">0</span> <span class="number">106</span> yx <span class="number">0</span> <span class="number">107</span> yx <span class="number">0</span> <span class="number">108</span> yx <span class="number">0</span> <span class="number">109</span> yx <span class="number">0</span> <span class="number">110</span> yx <span class="number">0</span> <span class="number">111</span> yx <span class="number">0</span> <span class="number">112</span> yx <span class="number">0</span> <span class="number">113</span> yx <span class="number">0</span> <span class="number">114</span> yx <span class="number">0</span> <span class="number">115</span> yx <span class="number">0</span> <span class="number">116</span> yx <span class="number">0</span> <span class="number">117</span> yx <span class="number">0</span> <span class="number">118</span> yx <span class="number">0</span> <span class="number">119</span> yx <span class="number">0</span> <span class="number">120</span> yx <span class="number">0</span> <span class="number">121</span> yx <span class="number">0</span> <span class="number">122</span> yx <span class="number">0</span> <span class="number">123</span> yx <span class="number">0</span> <span class="number">124</span> yx <span class="number">0</span> <span class="number">125</span> yx <span class="number">0</span> <span class="number">126</span> yx <span class="number">0</span> <span class="number">127</span> yx <span class="number">0</span> <span class="number">128</span> yx <span class="number">0</span> <span class="number">129</span> yx <span class="number">0</span> <span class="number">130</span> yx <span class="number">0</span> <span class="number">131</span> y</span><br><span class="line">        , got</span><br><span class="line">        x <span class="number">0</span> <span class="number">0</span> yx <span class="number">0</span> <span class="number">1</span> yx <span class="number">0</span> <span class="number">2</span> yx <span class="number">0</span> <span class="number">3</span> yx <span class="number">0</span> <span class="number">4</span> yx <span class="number">0</span> <span class="number">5</span> yx <span class="number">0</span> <span class="number">6</span> yx <span class="number">0</span> <span class="number">7</span> yx <span class="number">0</span> <span class="number">8</span> yx <span class="number">0</span> <span class="number">9</span> yx <span class="number">0</span> <span class="number">10</span> yx <span class="number">0</span> <span class="number">11</span> yx <span class="number">0</span> <span class="number">12</span> yx <span class="number">0</span> <span class="number">13</span> yx <span class="number">0</span> <span class="number">14</span> yx <span class="number">0</span> <span class="number">15</span> yx <span class="number">0</span> <span class="number">16</span> yx <span class="number">0</span> <span class="number">17</span> yx <span class="number">0</span> <span class="number">18</span> yx <span class="number">0</span> <span class="number">19</span> yx <span class="number">0</span> <span class="number">20</span> yx <span class="number">0</span> <span class="number">21</span> yx <span class="number">0</span> <span class="number">22</span> yx <span class="number">0</span> <span class="number">23</span> yx <span class="number">0</span> <span class="number">24</span> yx <span class="number">0</span> <span class="number">25</span> yx <span class="number">0</span> <span class="number">26</span> yx <span class="number">0</span> <span class="number">27</span> yx <span class="number">0</span> <span class="number">28</span> yx <span class="number">0</span> <span class="number">29</span> yx <span class="number">0</span> <span class="number">30</span> yx <span class="number">0</span> <span class="number">31</span> yx <span class="number">0</span> <span class="number">32</span> yx <span class="number">0</span> <span class="number">33</span> yx <span class="number">0</span> <span class="number">34</span> yx <span class="number">0</span> <span class="number">35</span> yx <span class="number">0</span> <span class="number">36</span> yx <span class="number">0</span> <span class="number">37</span> yx <span class="number">0</span> <span class="number">38</span> yx <span class="number">0</span> <span class="number">39</span> yx <span class="number">0</span> <span class="number">40</span> yx <span class="number">0</span> <span class="number">41</span> yx <span class="number">0</span> <span class="number">42</span> yx <span class="number">0</span> <span class="number">43</span> yx <span class="number">0</span> <span class="number">44</span> yx <span class="number">0</span> <span class="number">45</span> yx <span class="number">0</span> <span class="number">46</span> yx <span class="number">0</span> <span class="number">47</span> yx <span class="number">0</span> <span class="number">48</span> yx <span class="number">0</span> <span class="number">49</span> yx <span class="number">0</span> <span class="number">50</span> yx <span class="number">0</span> <span class="number">51</span> yx <span class="number">0</span> <span class="number">52</span> yx <span class="number">0</span> <span class="number">53</span> yx <span class="number">0</span> <span class="number">54</span> yx <span class="number">0</span> <span class="number">55</span> yx <span class="number">0</span> <span class="number">56</span> yx <span class="number">0</span> <span class="number">57</span> yx <span class="number">0</span> <span class="number">58</span> yx <span class="number">0</span> <span class="number">59</span> yx <span class="number">0</span> <span class="number">60</span> yx <span class="number">0</span> <span class="number">61</span> yx <span class="number">0</span> <span class="number">62</span> yx <span class="number">0</span> <span class="number">63</span> yx <span class="number">0</span> <span class="number">64</span> yx <span class="number">0</span> <span class="number">65</span> yx <span class="number">0</span> <span class="number">66</span> yx <span class="number">0</span> <span class="number">67</span> yx <span class="number">0</span> <span class="number">68</span> yx <span class="number">0</span> <span class="number">69</span> yx <span class="number">0</span> <span class="number">70</span> yx <span class="number">0</span> <span class="number">71</span> yx <span class="number">0</span> <span class="number">72</span> yx <span class="number">0</span> <span class="number">73</span> yx <span class="number">0</span> <span class="number">74</span> yx <span class="number">0</span> <span class="number">75</span> yx <span class="number">0</span> <span class="number">76</span> yx <span class="number">0</span> <span class="number">77</span> yx <span class="number">0</span> <span class="number">78</span> yx <span class="number">0</span> <span class="number">79</span> yx <span class="number">0</span> <span class="number">80</span> yx <span class="number">0</span> <span class="number">81</span> yx <span class="number">0</span> <span class="number">82</span> yx <span class="number">0</span> <span class="number">83</span> yx <span class="number">0</span> <span class="number">84</span> yx <span class="number">0</span> <span class="number">85</span> yx <span class="number">0</span> <span class="number">86</span> yx <span class="number">0</span> <span class="number">87</span> yx <span class="number">0</span> <span class="number">88</span> yx <span class="number">0</span> <span class="number">89</span> yx <span class="number">0</span> <span class="number">90</span> yx <span class="number">0</span> <span class="number">91</span> yx <span class="number">0</span> <span class="number">92</span> yx <span class="number">0</span> <span class="number">93</span> yx <span class="number">0</span> <span class="number">94</span> yx <span class="number">0</span> <span class="number">95</span> yx <span class="number">0</span> <span class="number">96</span> yx <span class="number">0</span> <span class="number">97</span> yx <span class="number">0</span> <span class="number">98</span> yx <span class="number">0</span> <span class="number">99</span> yx <span class="number">0</span> <span class="number">100</span> yx <span class="number">0</span> <span class="number">101</span> yx <span class="number">0</span> <span class="number">102</span> yx <span class="number">0</span> <span class="number">103</span> yx <span class="number">0</span> <span class="number">104</span> yx <span class="number">0</span> <span class="number">105</span> yx <span class="number">0</span> <span class="number">106</span> yx <span class="number">0</span> <span class="number">107</span> yx <span class="number">0</span> <span class="number">108</span> yx <span class="number">0</span> <span class="number">109</span> yx <span class="number">0</span> <span class="number">110</span> yx <span class="number">0</span> <span class="number">111</span> yx <span class="number">0</span> <span class="number">112</span> yx <span class="number">0</span> <span class="number">113</span> yx <span class="number">0</span> <span class="number">114</span> yx <span class="number">0</span> <span class="number">115</span> yx <span class="number">0</span> <span class="number">116</span> yx <span class="number">0</span> <span class="number">117</span> yx <span class="number">0</span> <span class="number">118</span> yx <span class="number">0</span> <span class="number">119</span> yx <span class="number">0</span> <span class="number">120</span> yx <span class="number">0</span> <span class="number">121</span> yx <span class="number">0</span> <span class="number">122</span> yx <span class="number">0</span> <span class="number">123</span> yx <span class="number">0</span> <span class="number">124</span> yx <span class="number">0</span> <span class="number">125</span> yx <span class="number">0</span> <span class="number">126</span> yx <span class="number">0</span> <span class="number">127</span> yx <span class="number">0</span> <span class="number">128</span> yx <span class="number">0</span> <span class="number">129</span> y</span><br><span class="line">    test_test.<span class="keyword">go</span>:<span class="number">120</span>: failure</span><br></pre></td></tr></table></figure>

<p>在 <code>APPEND</code> <code>x 0 129 y</code> 和下一条 <code>GET</code> 指令之间有两条 <code>APPEND</code> 指令没有被执行。这个问题出现在Recover 操作之后，Service 的 <code>data</code> 恢复到了快照时的状态，但 Raft 的 <code>lastApplied</code> 并没有跟着回退，导致中间有一些 entry 没有被 apply 到 service，而我之前的 service 实现没有检查收到的 <code>logIndex</code> 是否连续，导致有些指令被跳过。</p>
<p>目前采用的解决方法是，从 <code>applyCh</code> 获取到操作指令时进行检查，若 <code>command.logIndex - 1 == kv.appliedIndex</code> 则指令可以正常执行，若 <code>command.logIndex - 1 &gt; kv.appliedIndex</code> 则说明中间有log 被跳过，要求 Raft 回退 <code>rf.lastApplied</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> data := <span class="keyword">range</span> kv.applyCh &#123;</span><br><span class="line">	<span class="keyword">if</span> data.CommandValid &#123;</span><br><span class="line">		logIndex := data.CommandIndex</span><br><span class="line">		kv.mu.Lock()</span><br><span class="line">		<span class="keyword">if</span> logIndex<span class="number">-1</span> &gt; kv.appliedIndex &#123;</span><br><span class="line">			kv.rf.RollbackApply(kv.appliedIndex)</span><br><span class="line">			kv.mu.Unlock()</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left  disabled "
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2021/05/09/saladict-theme/"
      title="写了一个沙拉查词的 CSS 样式"
     >

    <p class="title-text">
      
        写了一个沙拉查词的 CSS 样式
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 Saica.go<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vix">Vix</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
